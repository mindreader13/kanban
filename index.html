<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â∞àÊ°àÁúãÊùø - Project Kanban</title>
    <style>
        :root {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --bg-column: rgba(255, 255, 255, 0.95);
            --text-primary: #333;
            --text-secondary: #666;
            --text-muted: #999;
            --border-color: #eee;
            --accent: #667eea;
            --accent-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --shadow: 0 10px 40px rgba(0,0,0,0.1);
            --shadow-hover: 0 15px 50px rgba(0,0,0,0.15);
            --radius: 12px;
            --tag-work: #4facfe;
            --tag-personal: #43e97b;
            --tag-urgent: #ff6b6b;
            --tag-other: #a855f7;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-column: rgba(22, 33, 62, 0.95);
            --text-primary: #eee;
            --text-secondary: #aaa;
            --text-muted: #666;
            --border-color: #333;
            --shadow: 0 10px 40px rgba(0,0,0,0.3);
            --shadow-hover: 0 15px 50px rgba(0,0,0,0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        h1 {
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--accent-gradient);
            color: white;
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-danger {
            background: #ff6b6b;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }
        
        .board {
            display: flex;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            overflow-x: auto;
            padding-bottom: 20px;
            align-items: flex-start;
        }
        
        .column {
            background: var(--bg-column);
            border-radius: var(--radius);
            min-width: 320px;
            max-width: 320px;
            padding: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s;
        }
        
        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .column-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .task-count {
            background: var(--accent);
            color: white;
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
        }
        
        .todo .task-count { background: #f093fb; }
        .inprogress .task-count { background: #4facfe; }
        .done .task-count { background: #43e97b; }
        .archive .task-count { background: #666; }
        
        .task-list {
            min-height: 200px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .task {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px;
            cursor: grab;
            transition: all 0.2s;
            position: relative;
        }
        
        .task:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }
        
        .task.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        
        .task-title {
            font-size: 0.95rem;
            margin-bottom: 8px;
            word-break: break-word;
        }
        
        .task-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .task-tags {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        
        .tag {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            color: white;
        }
        
        .tag-work { background: var(--tag-work); }
        .tag-personal { background: var(--tag-personal); }
        .tag-urgent { background: var(--tag-urgent); }
        .tag-other { background: var(--tag-other); }
        
        .task-due {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
        }
        
        .task-due.overdue {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            font-weight: 600;
        }
        
        .task-due.soon {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }
        
        .task-subtasks {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--border-color);
            font-size: 0.8rem;
        }
        
        .subtask {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 0;
            color: var(--text-secondary);
        }
        
        .subtask input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
        }
        
        .subtask.completed {
            text-decoration: line-through;
            opacity: 0.5;
        }
        
        .task-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: none;
            gap: 4px;
        }
        
        .task:hover .task-actions {
            display: flex;
        }
        
        .task-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            padding: 4px 6px;
            border-radius: 4px;
            transition: all 0.2s;
            opacity: 0.6;
        }
        
        .task-btn:hover {
            opacity: 1;
            background: var(--border-color);
        }
        
        .task-btn.delete:hover {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }
        
        .add-task {
            width: 100%;
            padding: 10px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            background: none;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.9rem;
            transition: all 0.2s;
            margin-top: 10px;
        }
        
        .add-task:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(102, 126, 234, 0.05);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            padding: 25px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: var(--text-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.95rem;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .tags-input {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            min-height: 44px;
            align-items: center;
        }
        
        .tags-input input {
            border: none;
            outline: none;
            flex: 1;
            min-width: 80px;
            padding: 4px;
            background: transparent;
            color: var(--text-primary);
        }
        
        .tag-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            color: white;
        }
        
        .tag-item button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            opacity: 0.7;
            color: white;
        }
        
        .tag-item button:hover {
            opacity: 1;
        }
        
        .subtasks-list {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .subtask-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .subtask-item:last-child {
            border-bottom: none;
        }
        
        .subtask-item input[type="text"] {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            color: var(--text-primary);
        }
        
        .subtask-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        
        .add-subtask-btn {
            background: none;
            border: 1px dashed var(--border-color);
            padding: 8px;
            width: 100%;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-top: 8px;
        }
        
        .add-subtask-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--accent-gradient);
            color: white;
        }
        
        .btn-secondary {
            background: var(--border-color);
            color: var(--text-primary);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }
        
        /* Board selector */
        .board-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            max-width: 1400px;
            margin: 0 auto 20px;
        }
        
        .board-selector select {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        
        /* Archive column */
        .archive-column {
            min-width: 280px;
            max-width: 280px;
        }
        
        /* Loading spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: var(--text-muted);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Login screen */
        .login-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            padding: 20px;
        }
        
        .login-screen h1 {
            margin-bottom: 30px;
        }
        
        .login-screen .btn {
            padding: 15px 30px;
            font-size: 1.1rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .board {
                flex-direction: column;
            }
            
            .column {
                max-width: 100%;
                min-width: 100%;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-screen" style="display: none;">
        <h1>üìã Â∞àÊ°àÁúãÊùø - Project Kanban</h1>
        <p style="margin-bottom: 30px; color: var(--text-secondary);">Ë´ãÁôªÂÖ•‰ª•Â≠òÂèñ‰Ω†ÁöÑÁúãÊùø</p>
        <button class="btn btn-primary" onclick="signInWithGoogle()">
            üîê ‰ΩøÁî® Google Â∏≥Êà∂ÁôªÂÖ•
        </button>
    </div>
    
    <!-- Main App -->
    <div id="main-app" style="display: none;">
        <div class="header">
            <h1>üìã Â∞àÊ°àÁúãÊùø - Project Kanban</h1>
            <div class="header-actions">
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">?</div>
                    <span id="user-name">User</span>
                </div>
                <button class="btn btn-secondary" onclick="toggleTheme()">üåô Theme</button>
                <button class="btn btn-secondary" onclick="openBoardModal()">üìÅ New Board</button>
                <button class="btn btn-secondary" onclick="openArchiveModal()">üì¶ Archive</button>
                <button class="btn btn-danger" onclick="signOut()">ÁôªÂá∫</button>
            </div>
        </div>
        
        <div class="board-selector">
            <label>Board:</label>
            <select id="board-selector" onchange="switchBoard(this.value)">
                <option value="default">Default Board</option>
            </select>
        </div>
        
        <div class="board">
            <!-- To Do -->
            <div class="column todo" data-status="todo">
                <div class="column-header">
                    <span class="column-title">üìù ÂæÖËôïÁêÜ</span>
                    <span class="task-count">0</span>
                </div>
                <div class="task-list" id="todo-list">
                    <div class="loading"><div class="spinner"></div>ËºâÂÖ•‰∏≠...</div>
                </div>
                <button class="add-task" onclick="openModal('todo')">+ Êñ∞Â¢û‰ªªÂãô</button>
            </div>
            
            <!-- In Progress -->
            <div class="column inprogress" data-status="inprogress">
                <div class="column-header">
                    <span class="column-title">üî• ÈÄ≤Ë°å‰∏≠</span>
                    <span class="task-count">0</span>
                </div>
                <div class="task-list" id="inprogress-list">
                    <div class="loading"><div class="spinner"></div>ËºâÂÖ•‰∏≠...</div>
                </div>
                <button class="add-task" onclick="openModal('inprogress')">+ Êñ∞Â¢û‰ªªÂãô</button>
            </div>
            
            <!-- Done -->
            <div class="column done" data-status="done">
                <div class="column-header">
                    <span class="column-title">‚úÖ Â∑≤ÂÆåÊàê</span>
                    <span class="task-count">0</span>
                </div>
                <div class="task-list" id="done-list">
                    <div class="loading"><div class="spinner"></div>ËºâÂÖ•‰∏≠...</div>
                </div>
                <button class="add-task" onclick="openModal('done')">+ Êñ∞Â¢û‰ªªÂãô</button>
            </div>
            
            <!-- Archive -->
            <div class="column archive archive-column" data-status="archive">
                <div class="column-header">
                    <span class="column-title">üì¶ Â∞ÅÂ≠ò</span>
                    <span class="task-count">0</span>
                </div>
                <div class="task-list" id="archive-list">
                    <div class="loading"><div class="spinner"></div>ËºâÂÖ•‰∏≠...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Task Modal -->
    <div class="modal" id="task-modal">
        <div class="modal-content">
            <h3 class="modal-title">Êñ∞Â¢û‰ªªÂãô</h3>
            <div class="form-group">
                <label>‰ªªÂãôÂêçÁ®± *</label>
                <input type="text" id="task-title" placeholder="Ëº∏ÂÖ•‰ªªÂãôÂêçÁ®±">
            </div>
            <div class="form-group">
                <label>ÊèèËø∞</label>
                <textarea id="task-desc" placeholder="Ëº∏ÂÖ•‰ªªÂãôÊèèËø∞ÔºàÂèØÈÅ∏Ôºâ"></textarea>
            </div>
            <div class="form-group">
                <label>Êà™Ê≠¢Êó•Êúü</label>
                <input type="date" id="task-due">
            </div>
            <div class="form-group">
                <label>Ê®ôÁ±§</label>
                <div class="tags-input" id="tags-container">
                    <input type="text" id="tag-input" placeholder="Ëº∏ÂÖ•Ê®ôÁ±§‰∏¶Êåâ Enter" onkeypress="handleTagInput(event)">
                </div>
            </div>
            <div class="form-group">
                <label>Â≠ê‰ªªÂãô</label>
                <div class="subtasks-list" id="subtasks-container">
                    <div class="subtask-item">
                        <input type="checkbox" onchange="updateSubtaskStatus(this)">
                        <input type="text" placeholder="Ëº∏ÂÖ•Â≠ê‰ªªÂãô" onkeypress="handleSubtaskInput(event, this)">
                        <button class="task-btn" onclick="removeSubtask(this)">‚úï</button>
                    </div>
                </div>
                <button class="add-subtask-btn" onclick="addSubtaskInput()">+ Êñ∞Â¢ûÂ≠ê‰ªªÂãô</button>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">ÂèñÊ∂à</button>
                <button class="btn btn-primary" onclick="saveTask()">ÂÑ≤Â≠ò</button>
            </div>
        </div>
    </div>
    
    <!-- Board Modal -->
    <div class="modal" id="board-modal">
        <div class="modal-content">
            <h3 class="modal-title">Êñ∞Â¢ûÁúãÊùø</h3>
            <div class="form-group">
                <label>ÁúãÊùøÂêçÁ®± *</label>
                <input type="text" id="board-name" placeholder="Ëº∏ÂÖ•ÁúãÊùøÂêçÁ®±">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeBoardModal()">ÂèñÊ∂à</button>
                <button class="btn btn-primary" onclick="createBoard()">Âª∫Á´ã</button>
            </div>
        </div>
    </div>
    
    <!-- Archive Modal -->
    <div class="modal" id="archive-modal">
        <div class="modal-content">
            <h3 class="modal-title">Â∞ÅÂ≠ò‰ªªÂãô</h3>
            <div id="archive-list-modal"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeArchiveModal()">ÈóúÈñâ</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, updateDoc, deleteDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDz-q39YiAtniSIKpJlZBjE-NaMm07vEtg",
            authDomain: "kanban-family.firebaseapp.com",
            projectId: "kanban-family",
            storageBucket: "kanban-family.firebasestorage.app",
            messagingSenderId: "96900774326",
            appId: "1:96900774326:web:7c9d379c64b8d061d1e917"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        // Global variables
        window.currentUser = null;
        window.currentBoard = 'default';
        window.tasks = [];
        window.boards = {};
        window.currentTags = [];
        window.editingTaskId = null;
        window.draggedTask = null;
        window.editingTask = null;
        
        // Theme
        window.toggleTheme = function() {
            const body = document.body;
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                localStorage.setItem('kanban-theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                localStorage.setItem('kanban-theme', 'dark');
            }
        };
        
        // Load theme
        if (localStorage.getItem('kanban-theme') === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
        }
        
        // Auth functions
        window.signInWithGoogle = async function() {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('Login error:', error);
                alert('ÁôªÂÖ•Â§±Êïó: ' + error.message);
            }
        };
        
        window.signOut = async function() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Logout error:', error);
            }
        };
        
        // Auth state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUser = user;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                document.getElementById('user-name').textContent = user.displayName || 'User';
                document.getElementById('user-avatar').textContent = (user.displayName || 'U')[0].toUpperCase();
                
                await loadData();
            } else {
                window.currentUser = null;
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
            }
        });
        
        // Load data from Firestore
        async function loadData() {
            if (!window.currentUser) return;
            
            const userId = window.currentUser.uid;
            
            // Load boards
            try {
                const boardsSnap = await getDocs(collection(db, 'users', userId, 'boards'));
                window.boards = { 'default': { name: 'Default Board' } };
                boardsSnap.forEach(doc => {
                    window.boards[doc.id] = doc.data();
                });
                updateBoardSelector();
            } catch (error) {
                console.error('Error loading boards:', error);
            }
            
            // Load tasks (real-time)
            const tasksQuery = query(collection(db, 'users', userId, 'tasks'), orderBy('created', 'desc'));
            onSnapshot(tasksQuery, (snapshot) => {
                window.tasks = [];
                snapshot.forEach(doc => {
                    window.tasks.push({ id: doc.id, ...doc.data() });
                });
                render();
            });
        }
        
        // Save task to Firestore
        async function saveTaskToFirestore(task) {
            if (!window.currentUser) return;
            const userId = window.currentUser.uid;
            
            if (task.id) {
                await setDoc(doc(db, 'users', userId, 'tasks', task.id), {
                    title: task.title,
                    description: task.description || '',
                    due: task.due || '',
                    tags: task.tags || [],
                    subtasks: task.subtasks || [],
                    status: task.status,
                    board: task.board,
                    created: task.created || new Date().toISOString()
                });
            } else {
                const newDoc = doc(collection(db, 'users', userId, 'tasks'));
                await setDoc(newDoc, {
                    title: task.title,
                    description: task.description || '',
                    due: task.due || '',
                    tags: task.tags || [],
                    subtasks: task.subtasks || [],
                    status: task.status,
                    board: task.board,
                    created: new Date().toISOString()
                });
            }
        }
        
        // Delete task from Firestore
        async function deleteTaskFromFirestore(taskId) {
            if (!window.currentUser) return;
            const userId = window.currentUser.uid;
            await deleteDoc(doc(db, 'users', userId, 'tasks', taskId));
        }
        
        // Board functions
        window.openBoardModal = function() {
            document.getElementById('board-modal').classList.add('active');
        };
        
        window.closeBoardModal = function() {
            document.getElementById('board-modal').classList.remove('active');
            document.getElementById('board-name').value = '';
        };
        
        window.createBoard = async function() {
            const name = document.getElementById('board-name').value.trim();
            if (!name) {
                alert('Ë´ãËº∏ÂÖ•ÁúãÊùøÂêçÁ®±');
                return;
            }
            const id = 'board_' + Date.now();
            window.boards[id] = { name: name };
            updateBoardSelector();
            
            // Save to Firestore
            if (window.currentUser) {
                await setDoc(doc(db, 'users', window.currentUser.uid, 'boards', id), { name: name });
            }
            
            closeBoardModal();
            switchBoard(id);
        };
        
        function updateBoardSelector() {
            const selector = document.getElementById('board-selector');
            selector.innerHTML = Object.entries(window.boards).map(([id, board]) => 
                `<option value="${id}" ${id === window.currentBoard ? 'selected' : ''}>${board.name}</option>`
            ).join('');
        }
        
        window.switchBoard = function(boardId) {
            window.currentBoard = boardId;
            render();
        };
        
        // Archive functions
        window.openArchiveModal = function() {
            const archivedTasks = window.tasks.filter(t => t.status === 'archive' && t.board === window.currentBoard);
            const container = document.getElementById('archive-list-modal');
            container.innerHTML = archivedTasks.length ? archivedTasks.map(task => `
                <div class="task" style="margin-bottom: 10px;">
                    <div class="task-title">${task.title}</div>
                    <div class="task-meta">
                        <span>${new Date(task.created).toLocaleDateString('zh-TW')}</span>
                        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.8rem;" onclick="unarchiveTask('${task.id}')">Âæ©Âéü</button>
                        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.8rem; color: #ff6b6b;" onclick="deleteTask('${task.id}')">Âà™Èô§</button>
                    </div>
                </div>
            `).join('') : '<p style="color: var(--text-muted); text-align: center;">Ê≤íÊúâÂ∞ÅÂ≠ò‰ªªÂãô</p>';
            document.getElementById('archive-modal').classList.add('active');
        };
        
        window.closeArchiveModal = function() {
            document.getElementById('archive-modal').classList.remove('active');
        };
        
        window.unarchiveTask = async function(id) {
            const task = window.tasks.find(t => t.id === id);
            if (task) {
                task.status = 'todo';
                await saveTaskToFirestore(task);
                openArchiveModal();
            }
        };
        
        // Render
        function render() {
            const columns = ['todo', 'inprogress', 'done', 'archive'];
            
            columns.forEach(status => {
                const list = document.getElementById(`${status}-list`);
                const count = document.querySelector(`.${status} .task-count`);
                const boardTasks = window.tasks.filter(t => t.board === window.currentBoard && t.status === status);
                
                list.innerHTML = boardTasks.map(task => {
                    const dueClass = getDueClass(task.due);
                    const subtasksHtml = task.subtasks && task.subtasks.length ? `
                        <div class="task-subtasks">
                            ${task.subtasks.map((st, i) => `
                                <div class="subtask ${st.completed ? 'completed' : ''}">
                                    <input type="checkbox" ${st.completed ? 'checked' : ''} onchange="toggleSubtask('${task.id}', ${i})">
                                    <span>${st.text}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : '';
                    
                    const tagsHtml = task.tags && task.tags.length ? `
                        <div class="task-tags">
                            ${task.tags.map(tag => `
                                <span class="tag tag-${tag.type || 'other'}">${tag.text}</span>
                            `).join('')}
                        </div>
                    ` : '';
                    
                    return `
                        <div class="task" draggable="true" data-id="${task.id}" ondragstart="dragStart(event)" ondragend="dragEnd(event)">
                            <div class="task-actions">
                                <button class="task-btn" onclick="editTask('${task.id}')">‚úèÔ∏è</button>
                                <button class="task-btn" onclick="archiveTask('${task.id}')">üì¶</button>
                                <button class="task-btn delete" onclick="deleteTask('${task.id}')">üóëÔ∏è</button>
                            </div>
                            <div class="task-title">${task.title}</div>
                            ${task.description ? `<div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">${task.description}</div>` : ''}
                            <div class="task-meta">
                                ${task.due ? `<span class="task-due ${dueClass}">üìÖ ${formatDate(task.due)}</span>` : ''}
                                ${tagsHtml}
                            </div>
                            ${subtasksHtml}
                        </div>
                    `;
                }).join('');
                
                count.textContent = boardTasks.length;
            });
        }
        
        function getDueClass(due) {
            if (!due) return '';
            const today = new Date();
            today.setHours(0,0,0,0);
            const dueDate = new Date(due);
            const diff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
            if (diff < 0) return 'overdue';
            if (diff <= 2) return 'soon';
            return '';
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return `${date.getMonth() + 1}/${date.getDate()}`;
        }
        
        // Modal functions
        window.openModal = function(status, taskId = null) {
            window.currentStatus = status;
            window.editingTaskId = taskId;
            window.currentTags = [];
            const modal = document.getElementById('task-modal');
            const title = document.querySelector('#task-modal .modal-title');
            
            document.getElementById('task-title').value = '';
            document.getElementById('task-desc').value = '';
            document.getElementById('task-due').value = '';
            document.getElementById('tags-container').innerHTML = `
                <input type="text" id="tag-input" placeholder="Ëº∏ÂÖ•Ê®ôÁ±§‰∏¶Êåâ Enter" onkeypress="handleTagInput(event)">
            `;
            document.getElementById('subtasks-container').innerHTML = `
                <div class="subtask-item">
                    <input type="checkbox" onchange="updateSubtaskStatus(this)">
                    <input type="text" placeholder="Ëº∏ÂÖ•Â≠ê‰ªªÂãô" onkeypress="handleSubtaskInput(event, this)">
                    <button class="task-btn" onclick="removeSubtask(this)">‚úï</button>
                </div>
            `;
            
            if (taskId) {
                window.editingTask = window.tasks.find(t => t.id === taskId);
                document.getElementById('task-title').value = window.editingTask.title;
                document.getElementById('task-desc').value = window.editingTask.description || '';
                document.getElementById('task-due').value = window.editingTask.due || '';
                window.currentTags = window.editingTask.tags || [];
                updateTagsDisplay();
                if (window.editingTask.subtasks) {
                    document.getElementById('subtasks-container').innerHTML = window.editingTask.subtasks.map((st, i) => `
                        <div class="subtask-item">
                            <input type="checkbox" ${st.completed ? 'checked' : ''} onchange="updateSubtaskStatus(this)">
                            <input type="text" value="${st.text}" onkeypress="handleSubtaskInput(event, this)">
                            <button class="task-btn" onclick="removeSubtask(this)">‚úï</button>
                        </div>
                    `).join('') + `
                        <div class="subtask-item">
                            <input type="checkbox" onchange="updateSubtaskStatus(this)">
                            <input type="text" placeholder="Ëº∏ÂÖ•Â≠ê‰ªªÂãô" onkeypress="handleSubtaskInput(event, this)">
                            <button class="task-btn" onclick="removeSubtask(this)">‚úï</button>
                        </div>
                    `;
                }
                title.textContent = 'Á∑®ËºØ‰ªªÂãô';
            } else {
                window.editingTask = null;
                title.textContent = 'Êñ∞Â¢û‰ªªÂãô';
            }
            
            modal.classList.add('active');
        };
        
        window.closeModal = function() {
            document.getElementById('task-modal').classList.remove('active');
            window.editingTaskId = null;
            window.editingTask = null;
        };
        
        // Tags functions
        window.handleTagInput = function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const input = document.getElementById('tag-input');
                const text = input.value.trim();
                if (text && !window.currentTags.find(t => t.text === text)) {
                    const types = ['work', 'personal', 'urgent', 'other'];
                    const type = types[window.currentTags.length % types.length];
                    window.currentTags.push({ text, type });
                    updateTagsDisplay();
                    input.value = '';
                }
            }
        };
        
        function updateTagsDisplay() {
            const container = document.getElementById('tags-container');
            container.innerHTML = window.currentTags.map(tag => `
                <span class="tag-item tag-${tag.type}" style="background: var(--tag-${tag.type});">
                    ${tag.text}
                    <button onclick="removeTag('${tag.text}')">√ó</button>
                </span>
            `).join('') + `
                <input type="text" id="tag-input" placeholder="Ëº∏ÂÖ•Ê®ôÁ±§‰∏¶Êåâ Enter" onkeypress="handleTagInput(event)">
            `;
        }
        
        window.removeTag = function(text) {
            window.currentTags = window.currentTags.filter(t => t.text !== text);
            updateTagsDisplay();
        };
        
        // Subtasks functions
        window.addSubtaskInput = function() {
            const container = document.getElementById('subtasks-container');
            container.innerHTML += `
                <div class="subtask-item">
                    <input type="checkbox" onchange="updateSubtaskStatus(this)">
                    <input type="text" placeholder="Ëº∏ÂÖ•Â≠ê‰ªªÂãô" onkeypress="handleSubtaskInput(event, this)">
                    <button class="task-btn" onclick="removeSubtask(this)">‚úï</button>
                </div>
            `;
        };
        
        window.handleSubtaskInput = function(e, input) {
            if (e.key === 'Enter') {
                e.preventDefault();
                window.addSubtaskInput();
            }
        };
        
        window.removeSubtask = function(btn) {
            const container = document.getElementById('subtasks-container');
            if (container.children.length > 1) {
                btn.parentElement.remove();
            }
        };
        
        window.updateSubtaskStatus = function(checkbox) {};
        
        function getSubtasks() {
            const items = document.querySelectorAll('#subtasks-container .subtask-item');
            return Array.from(items).map(item => ({
                text: item.querySelector('input[type="text"]').value,
                completed: item.querySelector('input[type="checkbox"]').checked
            })).filter(st => st.text.trim());
        }
        
        // Save task
        window.saveTask = async function() {
            const title = document.getElementById('task-title').value.trim();
            if (!title) {
                alert('Ë´ãËº∏ÂÖ•‰ªªÂãôÂêçÁ®±');
                return;
            }
            
            const description = document.getElementById('task-desc').value.trim();
            const due = document.getElementById('task-due').value;
            const subtasks = getSubtasks();
            
            const task = {
                id: window.editingTaskId,
                title,
                description,
                due,
                tags: window.currentTags,
                subtasks,
                status: window.currentStatus,
                board: window.currentBoard,
                created: window.editingTask?.created || new Date().toISOString()
            };
            
            await saveTaskToFirestore(task);
            window.closeModal();
        };
        
        // Delete task
        window.deleteTask = async function(id) {
            if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄã‰ªªÂãôÂóéÔºü')) {
                await deleteTaskFromFirestore(id);
            }
        };
        
        // Archive task
        window.archiveTask = async function(id) {
            const task = window.tasks.find(t => t.id === id);
            if (task) {
                task.status = 'archive';
                await saveTaskToFirestore(task);
            }
        };
        
        // Edit task
        window.editTask = function(id) {
            window.openModal(window.tasks.find(t => t.id === id).status, id);
        };
        
        // Toggle subtask
        window.toggleSubtask = async function(taskId, subtaskIndex) {
            const task = window.tasks.find(t => t.id === taskId);
            if (task && task.subtasks[subtaskIndex]) {
                task.subtasks[subtaskIndex].completed = !task.subtasks[subtaskIndex].completed;
                await saveTaskToFirestore(task);
            }
        };
        
        // Drag & Drop
        window.dragStart = function(e) {
            window.draggedTask = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        };
        
        window.dragEnd = function(e) {
            e.target.classList.remove('dragging');
            window.draggedTask = null;
        };
        
        // Setup drop zones
        document.querySelectorAll('.task-list').forEach(list => {
            list.addEventListener('dragover', e => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });
            
            list.addEventListener('drop', async e => {
                e.preventDefault();
                if (window.draggedTask) {
                    const newStatus = list.id.replace('-list', '');
                    const taskId = window.draggedTask.dataset.id;
                    const task = window.tasks.find(t => t.id === taskId);
                    if (task && task.status !== newStatus) {
                        task.status = newStatus;
                        await saveTaskToFirestore(task);
                    }
                }
            });
        });
        
        // Close modal on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', e => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
        
        // Make functions available globally
        window.signInWithGoogle = signInWithGoogle;
        window.signOut = signOut;
    </script>
</body>
</html>